# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  - group: awskeys

stages:
  - stage: init
    displayName: "Copying repo" 
    jobs:
     - job: Repo_clone
       steps:
         - task: TerraformInstaller@2
           inputs:
             terraformVersion: 'latest'
            
         - task: TerraformCLI@2
           inputs:
             command: 'init'
             allowTelemetryCollection: true
             
         - task: TerraformCLI@2
           inputs:
             command: 'validate'
             allowTelemetryCollection: true
             
         - task: TerraformCLI@2
           inputs:
             command: 'plan'
             environmentServiceName: 'AN-serviceconnection'
             commandOptions: '''-var = var.aws_access_key =$(accesskey) -var =var.aws_access_key=$(secretkey)'
             allowTelemetryCollection: true
             providerServiceAws: 'AWSconnection'

         - task: TerraformCLI@2
           inputs:
             command: 'apply'
             environmentServiceName: 'AN-serviceconnection'
             allowTelemetryCollection: true
             providerServiceAws: 'AWSconnection'
         